name: Comprehensive Test Suite

on:
  # Run comprehensive tests on main branch weekly or when manually triggered
  schedule:
    - cron: '0 2 * * 1'  # Monday at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      # Run comprehensive tests when critical files change
      - 'src/server.js'
      - 'src/database.js'
      - 'src/middleware/**'
      - 'package.json'
      - 'package-lock.json'

jobs:
  unit-tests:
    name: Unit Tests (All)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run all unit tests with coverage
      run: npm run test:unit
      
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        fail_ci_if_error: false

  integration-tests:
    name: Integration Tests (Full)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run integration tests
      run: npm run test:integration
      env:
        NODE_ENV: test

  e2e-tests:
    name: E2E Tests (Full)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Start test server
      run: |
        npm run dev &
        sleep 10
      env:
        NODE_ENV: test
        PORT: 3000
        
    - name: Run E2E tests
      run: npm run test:e2e:ci
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  security-comprehensive:
    name: Security Analysis (Deep)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Full security audit
      run: npm audit --audit-level moderate
      
    - name: Run security regression tests
      run: node scripts/security/security-regression.test.js
      env:
        NODE_ENV: test
        
    - name: Check for vulnerabilities
      run: |
        if npm audit --audit-level high --json | grep -q '"vulnerabilities"'; then
          echo "High severity vulnerabilities found!"
          npm audit --audit-level high
          exit 1
        fi

  code-quality:
    name: Code Quality & Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Check code coverage thresholds
      run: npm run test:coverage
      
    - name: Validate package.json
      run: npm run test -- --passWithNoTests --testPathPattern="non-existent-path" --json --coverage=false || true

  production-smoke-tests:
    name: Production Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run production smoke tests
      run: npm run test:smoke
      env:
        NODE_ENV: production
        TEST_PRODUCTION: true

  comprehensive-summary:
    name: Comprehensive Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-comprehensive, code-quality]
    if: always()
    
    steps:
    - name: Test results summary
      run: |
        echo "## Comprehensive Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Analysis: ${{ needs.security-comprehensive.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && 
              "${{ needs.integration-tests.result }}" == "success" && 
              "${{ needs.e2e-tests.result }}" == "success" && 
              "${{ needs.security-comprehensive.result }}" == "success" && 
              "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "- 🎉 **All comprehensive tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ⚠️ **Some tests failed - review required**" >> $GITHUB_STEP_SUMMARY
        fi